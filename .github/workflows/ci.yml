# RealityCam CI Pipeline
#
# Workflow stages:
# 1. Lint & Type Check (fast feedback)
# 2. Unit Tests (parallel: web, iOS native, backend)
# 3. Integration Tests (requires containers)
# 4. E2E Tests (web only)
#
# Triggers:
# - Push to main branch
# - Pull requests to main branch

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  BUN_VERSION: 'latest'
  RUST_VERSION: 'stable'
  SQLX_OFFLINE: 'true'

jobs:
  # ============================================
  # Stage 1: Lint & Type Check (Fast Feedback)
  # ============================================

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: cargo-${{ runner.os }}-${{ hashFiles('backend/Cargo.lock') }}

      # Install all dependencies (monorepo)
      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # Web & Mobile (workspace-level)
      - name: Lint All
        run: bun lint

      - name: Type Check All
        run: bun typecheck

      # Backend
      - name: Lint Backend (Clippy)
        working-directory: backend
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Format Check Backend
        working-directory: backend
        run: cargo fmt --check

  # ============================================
  # Stage 2: Unit Tests (Parallel)
  # ============================================

  # Detect which parts of the codebase changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      ios: ${{ steps.filter.outputs.ios }}
      backend: ${{ steps.filter.outputs.backend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/shared/**'
            ios:
              - 'ios/**'
              - 'packages/shared/**'
            backend:
              - 'backend/**'
            shared:
              - 'packages/shared/**'

  unit-tests-web:
    name: Unit Tests (Web)
    runs-on: ubuntu-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Run Unit Tests
        working-directory: apps/web
        run: bun run test:unit --run

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-unit-results
          path: apps/web/test-results/

  unit-tests-ios:
    name: Unit Tests (iOS)
    runs-on: macos-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.ios == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Run Unit Tests
        run: |
          xcodebuild test \
            -project ios/Rial.xcodeproj \
            -scheme Rial \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -only-testing:RialTests \
            | xcpretty --color --report junit --output ios/test-results/junit.xml

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-unit-results
          path: ios/test-results/

  unit-tests-backend:
    name: Unit Tests (Backend)
    runs-on: ubuntu-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: cargo-${{ runner.os }}-${{ hashFiles('backend/Cargo.lock') }}

      - name: Build and Run Unit Tests
        working-directory: backend
        run: cargo test

      - name: Save Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/target/debug/deps/
            backend/target/debug/build/
          retention-days: 1

  # ============================================
  # Stage 3: Integration Tests
  # ============================================

  integration-tests:
    name: Integration Tests (Backend)
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-tests-web, unit-tests-ios, unit-tests-backend]
    if: |
      always() &&
      needs.detect-changes.outputs.backend == 'true' &&
      !cancelled()

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: realitycam_test
          POSTGRES_PASSWORD: realitycam_test
          POSTGRES_DB: realitycam_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:3.0
        env:
          SERVICES: s3
          AWS_DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/target/

      - name: Initialize LocalStack S3
        run: |
          aws --endpoint-url=http://localhost:4566 s3 mb s3://realitycam-media-test
          aws --endpoint-url=http://localhost:4566 s3 mb s3://realitycam-manifests-test
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1

      - name: Run Integration Tests
        working-directory: backend
        run: cargo test --test integration
        env:
          DATABASE_URL: postgres://realitycam_test:realitycam_test@localhost:5432/realitycam_test
          S3_ENDPOINT: http://localhost:4566
          S3_BUCKET: realitycam-media-test
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: us-east-1

  # ============================================
  # Stage 4: E2E Tests (Web)
  # ============================================

  e2e-tests-web:
    name: E2E Tests (Web)
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.web == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Check if Playwright is configured
        id: check-playwright
        working-directory: apps/web
        run: |
          if grep -q "@playwright/test" package.json; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "Playwright not configured, skipping browser install"
          fi

      - name: Install Playwright Browsers
        if: steps.check-playwright.outputs.configured == 'true'
        working-directory: apps/web
        run: bunx playwright install --with-deps chromium

      - name: Run E2E Tests (Production)
        working-directory: apps/web
        run: bun run test:e2e -- --project=chromium
        env:
          TEST_ENV: production
          PROD_URL: ${{ secrets.PROD_URL }}
          PROD_API_URL: ${{ secrets.PROD_API_URL }}

      - name: Upload E2E Report
        uses: actions/upload-artifact@v4
        if: always() && steps.check-playwright.outputs.configured == 'true'
        with:
          name: web-e2e-report
          path: apps/web/test-results/

      - name: Upload Playwright Screenshots
        uses: actions/upload-artifact@v4
        if: failure() && steps.check-playwright.outputs.configured == 'true'
        with:
          name: playwright-screenshots
          path: apps/web/test-results/screenshots/

  # ============================================
  # Summary Job
  # ============================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, detect-changes, unit-tests-web, unit-tests-ios, unit-tests-backend, integration-tests, e2e-tests-web]
    if: always()
    steps:
      - name: Check All Jobs
        run: |
          # Function to check job result (success or skipped is OK)
          check_job() {
            local result="$1"
            local name="$2"
            if [[ "$result" == "failure" ]] || [[ "$result" == "cancelled" ]]; then
              echo "❌ $name: $result"
              return 1
            elif [[ "$result" == "skipped" ]]; then
              echo "⏭️  $name: skipped (no relevant changes)"
              return 0
            else
              echo "✅ $name: $result"
              return 0
            fi
          }

          failed=0
          check_job "${{ needs.lint.result }}" "Lint" || failed=1
          check_job "${{ needs.detect-changes.result }}" "Detect Changes" || failed=1
          check_job "${{ needs.unit-tests-web.result }}" "Web Tests" || failed=1
          check_job "${{ needs.unit-tests-ios.result }}" "iOS Tests" || failed=1
          check_job "${{ needs.unit-tests-backend.result }}" "Backend Tests" || failed=1
          check_job "${{ needs.integration-tests.result }}" "Integration Tests" || failed=1
          check_job "${{ needs.e2e-tests-web.result }}" "E2E Tests" || failed=1

          if [[ $failed -eq 1 ]]; then
            echo ""
            echo "❌ CI failed - one or more jobs failed or were cancelled"
            exit 1
          fi

          echo ""
          echo "✅ All CI jobs passed or were skipped!"
