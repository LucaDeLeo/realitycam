<?xml version="1.0" encoding="UTF-8"?>
<story-context story-key="debug-1-backend-debug-endpoints">
  <story-reference>
    <file>docs/sprint-artifacts/stories/debug-1-backend-debug-endpoints.md</file>
    <epic>debug-observability</epic>
    <tech-spec>docs/tech-spec.md</tech-spec>
  </story-reference>

  <documentation-artifacts>
    <artifact path="docs/tech-spec.md" relevance="Lines 399-424 for database schema, Lines 214-234 for debug endpoint specifications, Lines 329-344 for config options"/>
    <artifact path="docs/architecture.md" relevance="Backend framework patterns, ADR-003 for Rust/Axum rationale, implementation patterns section"/>
  </documentation-artifacts>

  <existing-code>
    <!-- Routes pattern reference -->
    <file path="backend/src/routes/captures.rs" relevance="Route handler pattern, multipart parsing, error handling, state injection, response formatting">
      <key-patterns>
        - Router::new() with .route() chains
        - State(state): State&lt;AppState&gt; extraction
        - Extension(request_id): Extension&lt;Uuid&gt; for request ID
        - Result&lt;(StatusCode, Json&lt;ApiResponse&lt;T&gt;&gt;), ApiErrorWithRequestId&gt; return type
        - tracing::info!/debug! macros for logging
        - ApiError variants for error handling
      </key-patterns>
    </file>

    <!-- Route registration reference -->
    <file path="backend/src/routes/mod.rs" relevance="Route registration pattern, conditional feature flag mounting with debug_logs_enabled">
      <key-patterns>
        - AppState struct with db, challenge_store, config, storage
        - Conditional route mounting: if state.config.debug_logs_enabled { v1_router = v1_router.nest("/debug", debug::router()); }
        - Already includes: pub mod debug;
      </key-patterns>
    </file>

    <!-- Service registration reference -->
    <file path="backend/src/services/mod.rs" relevance="Service module exports pattern">
      <key-patterns>
        - Already includes: pub mod debug_logs;
        - Service functions exported with pub use
      </key-patterns>
    </file>

    <!-- Model registration reference -->
    <file path="backend/src/models/mod.rs" relevance="Model module exports pattern">
      <key-patterns>
        - Already includes: mod debug_log;
        - Already exports: BatchInsertResponse, CreateDebugLog, DebugLog, DebugLogDelete, DebugLogQuery, DebugLogStats, DeleteResponse, LevelCounts, LogLevel, LogSource, SourceCounts
      </key-patterns>
    </file>

    <!-- Server setup reference -->
    <file path="backend/src/main.rs" relevance="Server initialization, middleware stack, request ID extraction">
      <key-patterns>
        - X_REQUEST_ID header constant
        - extract_request_id middleware function
        - TraceLayer with request_id span
        - App state construction with Arc wrappers
      </key-patterns>
    </file>

    <!-- Config pattern reference -->
    <file path="backend/src/config.rs" relevance="Config struct with debug_logs_enabled, debug_logs_ttl_days, debug_logs_max_batch fields">
      <key-patterns>
        - debug_logs_enabled: bool (default true for dev)
        - debug_logs_ttl_days: u32 (default 7)
        - debug_logs_max_batch: usize (default 100)
        - Environment variable parsing with defaults
      </key-patterns>
    </file>

    <!-- Error handling reference -->
    <file path="backend/src/error.rs" relevance="ApiError enum, ApiErrorWithRequestId wrapper, error codes, HTTP status mapping">
      <key-patterns>
        - ApiError::Validation(String) for 400 errors
        - ApiError::Database(sqlx::Error) for DB errors
        - ApiErrorWithRequestId struct for response generation
        - IntoResponse implementation
      </key-patterns>
    </file>

    <!-- Existing debug routes implementation -->
    <file path="backend/src/routes/debug.rs" relevance="ALREADY IMPLEMENTED - Full debug routes with all endpoints">
      <implementation-status>COMPLETE</implementation-status>
      <endpoints>
        - POST /logs - create_logs handler (batch insert)
        - GET /logs - query_logs handler (filtered query)
        - GET /logs/stats - get_stats handler (aggregated statistics)
        - GET /logs/{id} - get_log_by_id handler (single entry)
        - DELETE /logs - delete_logs handler (filtered deletion)
      </endpoints>
      <features>
        - Batch size validation against config.debug_logs_max_batch
        - Query parameter validation
        - Request ID injection via Extension
        - Comprehensive integration tests
      </features>
    </file>

    <!-- Existing debug logs service -->
    <file path="backend/src/services/debug_logs.rs" relevance="ALREADY IMPLEMENTED - Service layer for debug log operations">
      <implementation-status>COMPLETE</implementation-status>
      <functions>
        - insert_batch(pool, logs) - Transactional batch insert
        - query(pool, query) - Dynamic SQL query with filters
        - get_by_id(pool, id) - Single log lookup
        - delete(pool, params) - Filtered deletion
        - get_stats(pool) - Aggregated counts by source/level
      </functions>
    </file>

    <!-- Existing debug log model -->
    <file path="backend/src/models/debug_log.rs" relevance="ALREADY IMPLEMENTED - All structs and enums for debug logging">
      <implementation-status>COMPLETE</implementation-status>
      <types>
        - LogSource enum (Ios, Backend, Web)
        - LogLevel enum (Debug, Info, Warn, Error)
        - DebugLog struct (database entity)
        - CreateDebugLog struct (API input DTO)
        - DebugLogQuery struct (query parameters)
        - DebugLogDelete struct (delete parameters)
        - DebugLogStats struct (aggregated stats response)
        - BatchInsertResponse, DeleteResponse
        - SourceCounts, LevelCounts
      </types>
    </file>

    <!-- Existing migration -->
    <file path="backend/migrations/20251205000001_create_debug_logs.sql" relevance="ALREADY IMPLEMENTED - Database schema">
      <implementation-status>COMPLETE</implementation-status>
      <schema>
        - debug_logs table with all columns
        - CHECK constraints for source and level
        - Indexes: correlation_id, timestamp DESC, source, event
        - Partial index for error-level logs
      </schema>
    </file>
  </existing-code>

  <development-constraints>
    <constraint type="security">Debug endpoints only enabled when DEBUG_LOGS_ENABLED=true</constraint>
    <constraint type="security">Endpoints return 404 (not 403) when disabled to avoid leaking feature presence</constraint>
    <constraint type="security">No authentication required (dev-only endpoints)</constraint>
    <constraint type="architecture">Use SQLx query macros for compile-time checked SQL</constraint>
    <constraint type="architecture">Return Result&lt;Json&lt;T&gt;, ApiError&gt; from handlers</constraint>
    <constraint type="architecture">Use tracing::info!/debug! for internal logging</constraint>
    <constraint type="validation">Batch size limited to DEBUG_LOGS_MAX_BATCH (default 100)</constraint>
    <constraint type="validation">Query limit clamped to 1000 maximum</constraint>
  </development-constraints>

  <dependencies>
    <external name="sqlx" version="0.8" purpose="Database queries with compile-time checking"/>
    <external name="axum" version="0.8" purpose="HTTP framework"/>
    <external name="serde" version="1" purpose="JSON serialization"/>
    <external name="serde_json" version="1" purpose="JSON handling for payload field"/>
    <external name="uuid" version="1" purpose="UUID generation and parsing"/>
    <external name="chrono" version="0.4" purpose="Timestamp handling"/>
    <external name="tracing" version="0.1" purpose="Structured logging"/>
    <internal module="backend/src/routes/mod.rs" purpose="Route registration with feature flag"/>
    <internal module="backend/src/error.rs" purpose="Error types and response conversion"/>
    <internal module="backend/src/config.rs" purpose="Configuration with debug_logs_* fields"/>
    <internal module="backend/src/types/mod.rs" purpose="ApiResponse wrapper type"/>
  </dependencies>

  <testing-context>
    <framework>cargo test with #[cfg(test)] modules</framework>
    <patterns>Integration tests in routes/debug.rs with real database, unit tests in models/debug_log.rs</patterns>
    <coverage>All CRUD operations, validation edge cases, filter combinations</coverage>
    <existing-tests>
      - test_create_logs_valid_batch
      - test_create_logs_oversized_batch
      - test_create_logs_empty_batch
      - test_query_logs_returns_entries
      - test_query_logs_filter_by_source
      - test_query_logs_filter_by_level
      - test_query_logs_filter_by_event_substring
      - test_query_logs_filter_by_correlation_id
      - test_query_logs_respects_limit
      - test_query_logs_order_asc
      - test_query_logs_combined_filters
      - test_query_logs_invalid_source
      - test_get_log_by_id_found
      - test_get_log_by_id_not_found
      - test_delete_logs_all
      - test_delete_logs_filter_by_source
      - test_delete_logs_filter_by_older_than
      - test_get_stats
      - test_get_stats_empty
    </existing-tests>
  </testing-context>

  <implementation-status>
    <summary>STORY ALREADY IMPLEMENTED</summary>
    <completed-tasks>
      <task>Task 1: Database Migration - COMPLETE (20251205000001_create_debug_logs.sql)</task>
      <task>Task 2: Debug Log Model - COMPLETE (models/debug_log.rs)</task>
      <task>Task 3: Debug Logs Service - COMPLETE (services/debug_logs.rs)</task>
      <task>Task 4: Debug Routes - COMPLETE (routes/debug.rs)</task>
      <task>Task 5: Wire Up Routes and Config - COMPLETE (routes/mod.rs, config.rs)</task>
      <task>Task 6: Tests - COMPLETE (integration tests in routes/debug.rs, unit tests in models/debug_log.rs)</task>
    </completed-tasks>
    <verification>
      All acceptance criteria from the story have been implemented:
      - AC-1: debug_logs table with all columns and indexes
      - AC-2: POST /debug/logs batch ingest with validation
      - AC-3: GET /debug/logs with all filter params
      - AC-4: GET /debug/logs/{id} single entry lookup
      - AC-5: DELETE /debug/logs filtered deletion
      - AC-6: GET /debug/logs/stats aggregated counts
      - AC-7: Configuration options (DEBUG_LOGS_ENABLED, DEBUG_LOGS_TTL_DAYS, DEBUG_LOGS_MAX_BATCH)
    </verification>
  </implementation-status>
</story-context>
